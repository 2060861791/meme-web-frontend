name: Deploy Vue3 Frontend

on:
  push:
    branches:
      - main # ç›‘å¬ main åˆ†æ”¯çš„ push äº‹ä»¶

jobs:
  deploy:
    runs-on: ubuntu-latest # GitHub æä¾›çš„ Ubuntu æœåŠ¡å™¨

    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ³ æ„å»º Docker é•œåƒï¼ˆä¼˜åŒ–ç¼“å­˜ï¼‰
        run: |
          IMAGE_NAME=$(echo "${{ secrets.DOCKER_IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          DOCKER_BUILDKIT=1 docker build --rm \
            --cache-from $IMAGE_NAME \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -t $IMAGE_NAME .

      - name: ğŸ å¯¼å‡ºå¹¶å‹ç¼© Docker é•œåƒ
        run: |
          IMAGE_NAME=$(echo "${{ secrets.DOCKER_IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          docker save $IMAGE_NAME | gzip > vue-app.tar.gz
          chmod 644 vue-app.tar.gz
          echo "ğŸ“Š å‹ç¼©åDockeré•œåƒå¤§å°:"
          ls -lh vue-app.tar.gz | awk '{print $5}'

      - name: ğŸ“¤ ä¸Šä¼ å‹ç¼©åŒ…åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "vue-app.tar.gz"
          target: "/home/${{ secrets.SSH_USER }}/"
          timeout: 1000s
          strip_components: 0
          overwrite: true
          debug: true

      - name: ğŸš€ åœ¨æœåŠ¡å™¨ä¸ŠåŠ è½½å¹¶è¿è¡Œé•œåƒ
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            IMAGE_NAME=$(echo "${{ secrets.DOCKER_IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
            cd /home/${{ secrets.SSH_USER }}

            # è§£å‹å¹¶åŠ è½½é•œåƒ
            gunzip -c vue-app.tar.gz | sudo docker load
            rm -f vue-app.tar.gz

            # é‡Šæ”¾å ç”¨çš„ 8080 ç«¯å£ï¼ˆä»…å½“å®¹å™¨æœªæ­£å¸¸é‡Šæ”¾æ—¶ï¼‰
            sudo docker stop vue-app || echo "Container vue-app not running."
            sudo docker rm vue-app || echo "Container vue-app does not exist."
            sudo fuser -k 8080/tcp || echo "No process using 8080"

            # æ¸…ç†æœªä½¿ç”¨çš„æ—§ Docker é•œåƒï¼ˆé˜²æ­¢å­˜å‚¨å ç”¨è¿‡å¤šï¼‰
            sudo docker image prune -f --filter "label=app=vue-app"

            # è¿è¡Œæ–°å®¹å™¨
            sudo docker run -d --restart always -p 8080:80 --name vue-app $IMAGE_NAME
